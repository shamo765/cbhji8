<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Video Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
            position: fixed;
            top: 0;
            left: 0;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }

        #mainVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            display: block;
        }

        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            z-index: 1000;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            flex: 1;
            max-width: 100px;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.9);
            transform: scale(0.95);
        }

        .control-btn.active {
            background: rgba(255, 255, 255, 0.35);
            border-color: rgba(255, 255, 255, 1);
        }

        @media (max-height: 600px) {
            .controls {
                padding: 10px;
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }

            .control-btn {
                padding: 8px 16px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="video-container">
        <video id="mainVideo" playsinline muted webkit-playsinline preload="auto">
            Your browser does not support the video tag.
        </video>
    </div>

    <div class="controls">
        <button class="control-btn" id="smileBtn">Smile</button>
        <button class="control-btn" id="leftBtn">Left</button>
        <button class="control-btn" id="rightBtn">Right</button>
    </div>

    <script>
        console.log('Video Player Initialized');

        const video = document.getElementById('mainVideo');
        const smileBtn = document.getElementById('smileBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');

        // Video paths - replace these with your actual video paths
        const videos = {
            smile: 'smile.mp4',
            left: 'left.mp4',
            right: 'right.mp4'
        };

        // Cache for preloaded video data
        const videoCache = {};
        let currentVideo = null;

        // Debug logging
        function debugLog(message, data) {
            console.log(`[VideoPlayer] ${message}`, data || '');
        }

        // Preload videos by creating blob URLs
        async function preloadAllVideos() {
            debugLog('Starting video preload');

            for (const [key, path] of Object.entries(videos)) {
                try {
                    // Create a test video element to check if file exists
                    const testVideo = document.createElement('video');
                    testVideo.src = path;
                    testVideo.muted = true;
                    testVideo.preload = 'metadata';

                    await new Promise((resolve, reject) => {
                        testVideo.addEventListener('loadedmetadata', () => {
                            debugLog(`Video ${key} metadata loaded successfully`);
                            videoCache[key] = path;
                            resolve();
                        });

                        testVideo.addEventListener('error', () => {
                            debugLog(`Error loading video ${key} from path: ${path}`);
                            reject();
                        });

                        // Timeout after 5 seconds
                        setTimeout(() => {
                            debugLog(`Timeout loading video ${key}`);
                            resolve();
                        }, 5000);
                    });
                } catch (error) {
                    debugLog(`Failed to preload ${key}: ${error.message}`);
                }
            }

            debugLog('Video preload complete', videoCache);
        }

        // Remove active class from all buttons
        function clearActiveButtons() {
            [smileBtn, leftBtn, rightBtn].forEach(btn => btn.classList.remove('active'));
        }

        // Play video and freeze at last frame
        function playVideo(videoType, button) {
            debugLog(`Playing video: ${videoType}`);

            clearActiveButtons();
            button.classList.add('active');

            // Reset and load new video
            const videoPath = videoCache[videoType] || videos[videoType];
            debugLog(`Video path: ${videoPath}`);

            video.pause();
            video.src = videoPath;
            video.currentTime = 0;

            // Load and play
            video.load();

            // Try to play after a short delay
            setTimeout(() => {
                video.play()
                    .then(() => {
                        currentVideo = videoType;
                        debugLog(`Video ${videoType} playing successfully`);
                    })
                    .catch(error => {
                        debugLog(`Error playing video: ${error.message}`);
                        // Try again with explicit muted
                        video.muted = true;
                        video.play().catch(e => {
                            debugLog(`Second play attempt failed: ${e.message}`);
                        });
                    });
            }, 50);
        }

        // Freeze video at last frame when it ends
        video.addEventListener('ended', () => {
            debugLog('Video ended, freezing at last frame');
            // Pause at last frame instead of seeking
            video.pause();
            if (video.duration) {
                video.currentTime = video.duration - 0.1;
            }
        });

        // Log video events for debugging
        video.addEventListener('loadstart', () => debugLog('Video loadstart'));
        video.addEventListener('loadeddata', () => debugLog('Video loadeddata'));
        video.addEventListener('canplay', () => debugLog('Video canplay'));
        video.addEventListener('error', (e) => debugLog('Video error', e));

        // Button event handlers
        function setupButton(button, videoType) {
            // Single handler for both touch and click
            const handleInteraction = (e) => {
                e.preventDefault();
                e.stopPropagation();
                debugLog(`Button pressed: ${videoType}`);
                playVideo(videoType, button);
            };

            // Use pointer events for better mobile support
            button.addEventListener('pointerdown', handleInteraction);

            // Fallback for older browsers
            if (!window.PointerEvent) {
                button.addEventListener('touchstart', handleInteraction);
                button.addEventListener('click', handleInteraction);
            }
        }

        setupButton(smileBtn, 'smile');
        setupButton(leftBtn, 'left');
        setupButton(rightBtn, 'right');

        // Prevent default video controls
        video.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            debugLog('DOM Content Loaded');

            // Set initial video properties
            video.controls = false;
            video.muted = true;
            video.playsInline = true;
            video.setAttribute('webkit-playsinline', 'true');
            video.setAttribute('playsinline', 'true');

            // Start preloading videos
            preloadAllVideos();
        });

        // Additional initialization for safety
        window.addEventListener('load', () => {
            debugLog('Window fully loaded');

            // Double-check video setup
            if (!Object.keys(videoCache).length) {
                preloadAllVideos();
            }
        });

        // Handle page visibility
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                debugLog('Page became visible');
            }
        });

        // Prevent scrolling and zooming
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
